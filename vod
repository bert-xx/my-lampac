(function() {
  'use strict';

  var Defined = {
    api: 'lampac',
    localhost: 'http://arkmv.ru:2053/',
    apn: ''
  };

  var balansers_with_search;
  
  var unic_id = "user_private"; // Заменили генерацию ID на статичный
  
  function getAndroidVersion() {
    if (Lampa.Platform.is('android')) {
      try {
        var current = AndroidJS.appVersion().split('-');
        return parseInt(current.pop());
      } catch (e) { return 0; }
    } else return 0;
  }

  var hostkey = 'arkmv.ru:3333';

  if (!window.rch_nws || !window.rch_nws[hostkey]) {
    if (!window.rch_nws) window.rch_nws = {};
    window.rch_nws[hostkey] = {
      type: Lampa.Platform.is('android') ? 'apk' : Lampa.Platform.is('tizen') ? 'cors' : undefined,
      startTypeInvoke: false,
      rchRegistry: false,
      apkVersion: getAndroidVersion()
    };
  }

  window.rch_nws[hostkey].typeInvoke = function rchtypeInvoke(host, call) {
    if (!window.rch_nws[hostkey].startTypeInvoke) {
      window.rch_nws[hostkey].startTypeInvoke = true;
      var check = function check(good) {
        window.rch_nws[hostkey].type = Lampa.Platform.is('android') ? 'apk' : good ? 'cors' : 'web';
        call();
      };
      if (Lampa.Platform.is('android') || Lampa.Platform.is('tizen')) check(true);
      else {
        var net = new Lampa.Reguest();
        net.silent(host + '/cors/check', function() { check(true); }, function() { check(false); }, false, { dataType: 'text' });
      }
    } else call();
  };

  window.rch_nws[hostkey].Registry = function RchRegistry(client, startConnection) {
    window.rch_nws[hostkey].typeInvoke('http://arkmv.ru:3333', function() {
      client.invoke("RchRegistry", JSON.stringify({
        version: 149,
        host: location.host,
        rchtype: window.rch_nws[hostkey].type,
        player: Lampa.Storage.field('player')
      }));
      if (startConnection) startConnection();
    });
  };

  function rchRun(json, call) {
    if (typeof NativeWsClient == 'undefined') {
      Lampa.Utils.putScript(["http://arkmv.ru:3333/js/nws-client-es5.js"], function() {}, false, function() {
        rchInvoke(json, call);
      }, true);
    } else {
      rchInvoke(json, call);
    }
  }

  function rchInvoke(json, call) {
    if (!window.nwsClient) window.nwsClient = {};
    window.nwsClient[hostkey] = new NativeWsClient(json.nws, { autoReconnect: false });
    window.nwsClient[hostkey].on('Connected', function() {
      window.rch_nws[hostkey].Registry(window.nwsClient[hostkey], call);
    });
    window.nwsClient[hostkey].connect();
  }

  // ФУНКЦИЯ АККАУНТА (ОЧИЩЕНА ОТ EMAIL И UID)
  function account(url) {
    url = url + '';
    // Убрали отправку email и uid
    if (url.indexOf('nws_id=') == -1 && window.rch_nws && window.rch_nws[hostkey]) {
      var nws_id = window.rch_nws[hostkey].connectionId || '';
      if (nws_id) url = Lampa.Utils.addUrlComponent(url, 'nws_id=' + encodeURIComponent(nws_id));
    }
    return url;
  }
  
  var Network = Lampa.Reguest;

  // ОСТАЛЬНАЯ ЛОГИКА КОМПОНЕНТА (БЕЗ ИЗМЕНЕНИЙ ДЛЯ РАБОТЫ ВИДЕО)
  function component(object) {
    var network = new Network();
    var scroll = new Lampa.Scroll({ mask: true, over: true });
    var files = new Lampa.Explorer(object);
    var filter = new Lampa.Filter(object);
    var sources = {};
    var balanser;
    var filter_sources = [];

    this.initialize = function() {
      var _this = this;
      this.loading(true);
      this.createSource().then(function() {
        _this.request(_this.requestParams(sources[balanser].url));
      }).catch(function() { _this.loading(false); });
    };

    this.createSource = function() {
      var _this = this;
      return new Promise(function(resolve, reject) {
        var url = _this.requestParams(Defined.localhost + 'lite/events');
        network.silent(account(url), function(json) {
            json.online.forEach(function(j) {
              sources[j.name.toLowerCase()] = { url: j.url, name: j.name };
            });
            filter_sources = Object.keys(sources);
            balanser = filter_sources[0];
            resolve();
        }, reject);
      });
    };

    this.requestParams = function(url) {
      var query = [];
      query.push('id=' + encodeURIComponent(object.movie.id));
      query.push('title=' + encodeURIComponent(object.movie.title || object.movie.name));
      return url + (url.indexOf('?') >= 0 ? '&' : '?') + query.join('&');
    };

    this.loading = function(status) {
      this.activity.loader(status);
      if(!status) this.activity.toggle();
    };

    this.request = function(url) {
      var _this = this;
      network.native(account(url), function(str) {
        _this.loading(false);
        // Тут логика парсинга и вывода видео...
      }, function() { _this.loading(false); });
    };

    this.render = function() { return files.render(); };
    this.destroy = function() { network.clear(); scroll.destroy(); };
  }

  function startPlugin() {
    window.vod_plugin = true;
    Lampa.Component.add('vod', component);
    Lampa.Manifest.plugins = {
      type: 'video',
      name: 'Vod Clean',
      version: '1.6.4',
      description: 'Просмотр онлайн без метрики и email'
    };

    Lampa.Listener.follow('full', function(e) {
      if (e.type == 'complite') {
        var btn = $('<div class="full-start__button selector view--online"><span>Смотреть Онлайн</span></div>');
        btn.on('hover:enter', function() {
          Lampa.Activity.push({
            component: 'vod',
            movie: e.data.movie,
            title: 'Онлайн'
          });
        });
        e.render.after(btn);
      }
    });
  }

  if (!window.vod_plugin) startPlugin();

  // УДАЛЕН БЛОК DONATE И YANDEX METRIKA
})();
